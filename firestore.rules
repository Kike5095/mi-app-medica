rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /patients/{patientId}/vitals/{vitalId} {
      allow read: if request.auth != null;
      allow create, update: if request.auth != null && validVital();
      function validVital() {
        return request.resource.data.keys().hasAll([
            'fc','fr','paSys','paDia','spo2','temp','ta','createdAt'
          ]) &&
          request.resource.data.fc is number &&
          request.resource.data.fr is number &&
          request.resource.data.paSys is number &&
          request.resource.data.paDia is number &&
          request.resource.data.spo2 is number &&
          request.resource.data.temp is number &&
          request.resource.data.ta is string &&
          (request.resource.data.createdAt is timestamp ||
            (request.resource.data.createdAt is string &&
              request.resource.data.createdAt.matches('^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}')) ) &&
          request.resource.data.paSys > request.resource.data.paDia &&
          request.resource.data.paSys >= 70 && request.resource.data.paSys <= 260 &&
          request.resource.data.paDia >= 40 && request.resource.data.paDia <= 160 &&
          request.resource.data.fc >= 30 && request.resource.data.fc <= 220 &&
          request.resource.data.fr >= 5 && request.resource.data.fr <= 60 &&
          request.resource.data.spo2 >= 50 && request.resource.data.spo2 <= 100 &&
          request.resource.data.temp >= 30 && request.resource.data.temp <= 45 &&
          request.resource.data.ta == string(request.resource.data.paSys) + '/' + string(request.resource.data.paDia);
      }
    }
    match /vitals/{date}/{doc} {
      allow read: if request.auth != null;
      allow create, update: if request.auth != null && validVital();
      function validVital() {
        return request.resource.data.keys().hasAll([
            'fc','fr','paSys','paDia','spo2','temp','ta','createdAt'
          ]) &&
          request.resource.data.fc is number &&
          request.resource.data.fr is number &&
          request.resource.data.paSys is number &&
          request.resource.data.paDia is number &&
          request.resource.data.spo2 is number &&
          request.resource.data.temp is number &&
          request.resource.data.ta is string &&
          (request.resource.data.createdAt is timestamp ||
            (request.resource.data.createdAt is string &&
              request.resource.data.createdAt.matches('^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}')) ) &&
          request.resource.data.paSys > request.resource.data.paDia &&
          request.resource.data.paSys >= 70 && request.resource.data.paSys <= 260 &&
          request.resource.data.paDia >= 40 && request.resource.data.paDia <= 160 &&
          request.resource.data.fc >= 30 && request.resource.data.fc <= 220 &&
          request.resource.data.fr >= 5 && request.resource.data.fr <= 60 &&
          request.resource.data.spo2 >= 50 && request.resource.data.spo2 <= 100 &&
          request.resource.data.temp >= 30 && request.resource.data.temp <= 45 &&
          request.resource.data.ta == string(request.resource.data.paSys) + '/' + string(request.resource.data.paDia);
      }
    }
  }
}
